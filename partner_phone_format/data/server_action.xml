<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="action_format_partner_phones" model="ir.actions.server">
        <field name="name">Formater les numéros de téléphone</field>
        <field name="model_id" ref="base.model_res_partner"/>
        <field name="binding_model_id" ref="base.model_res_partner"/>
        <field name="binding_view_types">list,form</field>
        <field name="state">code</field>
        <field name="code"><![CDATA[
from odoo.addons.phone_validation.tools import phone_validation

count = 0
for partner in records:
    vals = {}
    country_code = partner.country_id.code or env.company.country_id.code or 'FR'
    for field in ('phone', 'mobile'):
        value = getattr(partner, field)
        if value:
            formatted = phone_validation.phone_format(
                value,
                country_code,
                None,
                force_format='NATIONAL',
                raise_exception=False,
            )
            if formatted and formatted != value:
                vals[field] = formatted
    if vals:
        partner.write(vals)
        count += 1

if count:
    action = {
        'type': 'ir.actions.client',
        'tag': 'display_notification',
        'params': {
            'title': 'Formatage terminé',
            'message': f'{count} contact(s) mis à jour.',
            'type': 'success',
            'sticky': False,
        }
    }
else:
    action = {
        'type': 'ir.actions.client',
        'tag': 'display_notification',
        'params': {
            'title': 'Formatage terminé',
            'message': 'Aucun numéro à formater.',
            'type': 'info',
            'sticky': False,
        }
    }
]]></field>
    </record>
</odoo>
